<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amazon ASIN Audit Tool</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #FF9900;
            --dark-bg: #131921;
            --light-bg: #232f3e;
        }
        
        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .navbar {
            background: var(--dark-bg) !important;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        .navbar-brand {
            color: var(--primary-color) !important;
            font-weight: bold;
            font-size: 1.5rem;
        }
        
        .main-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 40px 20px;
        }
        
        .upload-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .upload-area {
            border: 3px dashed #dee2e6;
            border-radius: 15px;
            padding: 50px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }
        
        .upload-area:hover, .upload-area.dragover {
            border-color: var(--primary-color);
            background: #fff3e0;
        }
        
        .upload-area i {
            font-size: 4rem;
            color: var(--primary-color);
            margin-bottom: 20px;
        }
        
        .btn-amazon {
            background: var(--primary-color);
            border: none;
            color: #000;
            font-weight: bold;
            padding: 12px 40px;
            border-radius: 30px;
            font-size: 1.1rem;
            transition: all 0.3s ease;
        }
        
        .btn-amazon:hover {
            background: #e68a00;
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(255, 153, 0, 0.4);
        }
        
        .progress-container {
            display: none;
            margin-top: 30px;
        }
        
        .progress {
            height: 30px;
            border-radius: 15px;
            background: #e9ecef;
        }
        
        .progress-bar {
            background: linear-gradient(90deg, #FF9900, #ffb347);
            border-radius: 15px;
            transition: width 0.5s ease;
        }
        
        .status-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .status-icon {
            font-size: 2rem;
            margin-right: 15px;
        }
        
        .status-running { color: #007bff; }
        .status-completed { color: #28a745; }
        .status-error { color: #dc3545; }
        .status-queued { color: #ffc107; }
        
        .file-info {
            background: #e8f5e9;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            display: none;
        }
        
        .limits-info {
            background: #fff3e0;
            border-left: 4px solid var(--primary-color);
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 0 10px 10px 0;
        }
        
        .download-btn {
            display: none;
        }
        
        .spinner-grow-sm {
        }
        
        .spinner-grow-sm {
            width: 1rem;
            height: 1rem;
        }
        
        footer {
            text-align: center;
            color: rgba(255,255,255,0.6);
            padding: 20px;
            margin-top: 40px;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .processing-pulse {
            animation: pulse 1.5s infinite;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark">
        <div class="container">
            <div class="d-flex align-items-center">
                <svg width="50" height="50" viewBox="0 0 50 50" style="margin-right: 15px;">
                    <rect width="50" height="50" fill="#FF9900" rx="8"/>
                    <text x="25" y="32" font-size="28" font-weight="bold" text-anchor="middle" fill="white" font-family="Arial">A</text>
                </svg>
                <div>
                    <div class="navbar-brand mb-0" style="font-size: 1.8rem; font-weight: bold;">
                        Amazon ASIN Audit Tool
                    </div>
                    <small class="text-warning">Multi-User Web Version</small>
                </div>
            </div>
        </div>
    </nav>
    
    <div class="main-container">
        <div class="upload-card">
            <h2 class="text-center mb-4">
                <i class="fas fa-file-csv text-warning"></i> Upload Your ASIN File
            </h2>
            
            <div class="limits-info">
                <strong><i class="fas fa-info-circle"></i> Limits:</strong>
                <ul class="mb-0 mt-2">
                    <li>Maximum <strong>{{ max_asins }}</strong> ASINs per file</li>
                    <li>Supported formats: <strong>CSV, Excel (.xlsx, .xls)</strong></li>
                    <li>File must have an <strong>ASIN</strong> column</li>
                </ul>
            </div>
            
            <form id="uploadForm" enctype="multipart/form-data">
                <div class="upload-area" id="uploadArea">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <h4>Drag & Drop your file here</h4>
                    <p class="text-muted">or click to browse</p>
                    <input type="file" id="fileInput" name="file" accept=".csv,.xlsx,.xls" hidden>
                </div>
                
                <div class="file-info" id="fileInfo">
                    <i class="fas fa-file-excel text-success me-2"></i>
                    <span id="fileName"></span>
                    <button type="button" class="btn btn-sm btn-outline-danger float-end" id="removeFile">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="text-center mt-4">
                    <button type="submit" class="btn btn-amazon" id="submitBtn" disabled>
                        <i class="fas fa-play me-2"></i> Start Audit
                    </button>
                </div>
            </form>
            
            <div class="progress-container" id="progressContainer">
                <div class="status-card" id="statusCard">
                    <div class="d-flex align-items-center">
                        <span class="status-icon" id="statusIcon">
                            <i class="fas fa-spinner fa-spin"></i>
                        </span>
                        <div>
                            <h5 class="mb-1" id="statusTitle">Processing...</h5>
                            <p class="mb-0 text-muted" id="statusMessage">Your audit is being processed</p>
                        </div>
                    </div>
                </div>
                
                <div class="mt-3">
                    <div class="d-flex justify-content-between mb-2">
                        <span><strong>Progress:</strong></span>
                        <span id="progressText">0 / 0 ASINs</span>
                    </div>
                    <div class="progress">
                        <div class="progress-bar" id="progressBar" role="progressbar" style="width: 0%"></div>
                    </div>
                    <div class="row mt-3 text-center" id="statsRow">
                        <div class="col-4">
                            <div class="p-2 bg-light rounded">
                                <i class="fas fa-clock text-primary"></i>
                                <div class="small text-muted">Time Elapsed</div>
                                <strong id="elapsedTime">0:00</strong>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="p-2 bg-light rounded">
                                <i class="fas fa-hourglass-half text-warning"></i>
                                <div class="small text-muted">ETA</div>
                                <strong id="etaTime">Calculating...</strong>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="p-2 bg-light rounded">
                                <i class="fas fa-tachometer-alt text-success"></i>
                                <div class="small text-muted">Speed</div>
                                <strong id="speedRate">0/min</strong>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="text-center mt-4">
                    <button class="btn btn-danger btn-lg" id="stopBtn">
                        <i class="fas fa-stop me-2"></i> Stop & Download
                    </button>
                    <a href="#" class="btn btn-success btn-lg download-btn" id="downloadBtn" style="display: none;">
                        <i class="fas fa-download me-2"></i> Download Results
                    </a>
                </div>
                
                <div class="text-center mt-3">
                    <button class="btn btn-outline-primary" id="newAuditBtn" style="display: none;">
                        <i class="fas fa-plus me-2"></i> Start New Audit
                    </button>
                </div>
            </div>
        </div>
        
        <div class="mt-4 text-center">
            <div class="card bg-dark text-light">
                <div class="card-body">
                    <h5><i class="fas fa-chart-bar me-2"></i> What This Tool Extracts</h5>
                    <div class="row mt-3">
                        <div class="col-md-4">
                            <ul class="list-unstyled text-start">
                                <li><i class="fas fa-check text-success me-2"></i> Product Status</li>
                                <li><i class="fas fa-check text-success me-2"></i> Title</li>
                                <li><i class="fas fa-check text-success me-2"></i> Price & MRP</li>
                                <li><i class="fas fa-check text-success me-2"></i> Deal Info</li>
                            </ul>
                        </div>
                        <div class="col-md-4">
                            <ul class="list-unstyled text-start">
                                <li><i class="fas fa-check text-success me-2"></i> Ratings & Reviews</li>
                                <li><i class="fas fa-check text-success me-2"></i> BSR (Best Seller Rank)</li>
                                <li><i class="fas fa-check text-success me-2"></i> Brand Name</li>
                                <li><i class="fas fa-check text-success me-2"></i> Seller Info</li>
                            </ul>
                        </div>
                        <div class="col-md-4">
                            <ul class="list-unstyled text-start">
                                <li><i class="fas fa-check text-success me-2"></i> Availability</li>
                                <li><i class="fas fa-check text-success me-2"></i> Variations</li>
                                <li><i class="fas fa-check text-success me-2"></i> Browse Node</li>
                                <li><i class="fas fa-check text-success me-2"></i> Image URL</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <footer>
        <p>&copy; 2024 Amazon ASIN Audit Tool | Powered by Playwright</p>
    </footer>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');
        const submitBtn = document.getElementById('submitBtn');
        const uploadForm = document.getElementById('uploadForm');
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const statusIcon = document.getElementById('statusIcon');
        const statusTitle = document.getElementById('statusTitle');
        const statusMessage = document.getElementById('statusMessage');
        const downloadBtn = document.getElementById('downloadBtn');
        const newAuditBtn = document.getElementById('newAuditBtn');
        const removeFile = document.getElementById('removeFile');
        const stopBtn = document.getElementById('stopBtn');
        const elapsedTime = document.getElementById('elapsedTime');
        const etaTime = document.getElementById('etaTime');
        const speedRate = document.getElementById('speedRate');
        const statsRow = document.getElementById('statsRow');
        
        let currentJobId = null;
        let pollInterval = null;
        
        // Drag and drop handling
        uploadArea.addEventListener('click', () => fileInput.click());
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                fileInput.files = files;
                handleFileSelect(files[0]);
            }
        });
        
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFileSelect(e.target.files[0]);
            }
        });
        
        function handleFileSelect(file) {
            const validExtensions = ['.csv', '.xlsx', '.xls'];
            const ext = file.name.substring(file.name.lastIndexOf('.')).toLowerCase();
            
            if (!validExtensions.includes(ext)) {
                alert('Invalid file type. Please upload a CSV or Excel file.');
                return;
            }
            
            fileName.textContent = file.name + ' (' + formatBytes(file.size) + ')';
            fileInfo.style.display = 'block';
            uploadArea.style.display = 'none';
            submitBtn.disabled = false;
        }
        
        removeFile.addEventListener('click', () => {
            fileInput.value = '';
            fileInfo.style.display = 'none';
            uploadArea.style.display = 'block';
            submitBtn.disabled = true;
        });
        
        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        uploadForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span> Uploading...';
            
            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.error) {
                    alert('Error: ' + data.error);
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fas fa-play me-2"></i> Start Audit';
                    return;
                }
                
                currentJobId = data.job_id;
                
                // Show progress container
                uploadForm.style.display = 'none';
                progressContainer.style.display = 'block';
                
                // Start polling for status (every 1 second for real-time updates)
                updateStatus('queued', 0, data.total_asins);
                pollInterval = setInterval(() => pollStatus(data.total_asins), 1000);
                
            } catch (error) {
                alert('Upload failed: ' + error.message);
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-play me-2"></i> Start Audit';
            }
        });
        
        async function pollStatus(total) {
            if (!currentJobId) return;
            
            try {
                const response = await fetch('/status/' + currentJobId);
                const data = await response.json();
                
                updateStatus(
                    data.status, 
                    data.progress, 
                    data.total, 
                    data.error,
                    data.eta_seconds || 0,
                    data.elapsed_seconds || 0,
                    data.rate_per_minute || 0
                );
                
                if (data.status === 'completed' || data.status === 'error' || data.status === 'stopped') {
                    clearInterval(pollInterval);
                }
            } catch (error) {
                console.error('Status poll error:', error);
            }
        }
        
        function formatTime(seconds) {
            if (seconds <= 0) return '0:00';
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return mins + ':' + secs.toString().padStart(2, '0');
        }
        
        function updateStatus(status, progress, total, error = null, eta = 0, elapsed = 0, rate = 0) {
            const percentage = total > 0 ? Math.round((progress / total) * 100) : 0;
            
            progressBar.style.width = percentage + '%';
            progressText.textContent = progress + ' / ' + total + ' ASINs (' + percentage + '%)';
            
            // Update time stats
            elapsedTime.textContent = formatTime(elapsed);
            etaTime.textContent = eta > 0 ? formatTime(eta) : 'Calculating...';
            speedRate.textContent = rate > 0 ? rate + '/min' : '...';
            
            switch (status) {
                case 'queued':
                    statusIcon.innerHTML = '<i class="fas fa-clock status-queued"></i>';
                    statusTitle.textContent = 'Starting...';
                    statusMessage.textContent = 'Launching browsers...';
                    stopBtn.style.display = 'inline-block';
                    stopBtn.disabled = false;
                    downloadBtn.style.display = 'none';
                    break;
                    
                case 'running':
                    statusIcon.innerHTML = '<i class="fas fa-cog fa-spin status-running"></i>';
                    statusTitle.textContent = 'Processing';
                    statusMessage.textContent = 'Auditing your ASINs...';
                    statusIcon.classList.add('processing-pulse');
                    stopBtn.style.display = 'inline-block';
                    stopBtn.disabled = false;
                    downloadBtn.style.display = 'none';
                    statsRow.style.display = 'flex';
                    break;
                    
                case 'completed':
                    statusIcon.innerHTML = '<i class="fas fa-check-circle status-completed"></i>';
                    statusTitle.textContent = 'Completed!';
                    statusMessage.textContent = 'Your audit is ready for download';
                    statusIcon.classList.remove('processing-pulse');
                    downloadBtn.style.display = 'inline-block';
                    downloadBtn.href = '/download/' + currentJobId;
                    downloadBtn.innerHTML = '<i class="fas fa-download me-2"></i> Download Results';
                    newAuditBtn.style.display = 'inline-block';
                    stopBtn.style.display = 'none';
                    progressBar.style.width = '100%';
                    statsRow.style.display = 'none';
                    break;
                
                case 'stopped':
                    statusIcon.innerHTML = '<i class="fas fa-stop-circle" style="color: #fd7e14;"></i>';
                    statusTitle.textContent = 'Stopped';
                    statusMessage.textContent = 'Audit stopped. Download your partial results below.';
                    statusIcon.classList.remove('processing-pulse');
                    downloadBtn.style.display = 'inline-block';
                    downloadBtn.href = '/download/' + currentJobId;
                    downloadBtn.innerHTML = '<i class="fas fa-download me-2"></i> Download Partial Results';
                    newAuditBtn.style.display = 'inline-block';
                    stopBtn.style.display = 'none';
                    statsRow.style.display = 'none';
                    break;
                    
                case 'error':
                    statusIcon.innerHTML = '<i class="fas fa-exclamation-circle status-error"></i>';
                    statusTitle.textContent = 'Error';
                    statusMessage.textContent = error || 'An error occurred during processing';
                    statusIcon.classList.remove('processing-pulse');
                    newAuditBtn.style.display = 'inline-block';
                    stopBtn.style.display = 'none';
                    break;
            }
        }
        
        // Stop button handler
        stopBtn.addEventListener('click', async () => {
            if (!currentJobId) return;
            
            stopBtn.disabled = true;
            stopBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span> Stopping...';
            
            try {
                const response = await fetch('/stop/' + currentJobId, {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (data.error) {
                    alert('Error: ' + data.error);
                    stopBtn.disabled = false;
                    stopBtn.innerHTML = '<i class="fas fa-stop me-2"></i> Stop & Download';
                    return;
                }
                
                // Update UI for stopped state
                clearInterval(pollInterval);
                updateStatus('stopped', data.progress, data.total);
                
            } catch (error) {
                alert('Failed to stop: ' + error.message);
                stopBtn.disabled = false;
                stopBtn.innerHTML = '<i class="fas fa-stop me-2"></i> Stop & Download';
            }
        });
        
        newAuditBtn.addEventListener('click', () => {
            currentJobId = null;
            clearInterval(pollInterval);
            
            // Reset UI
            uploadForm.style.display = 'block';
            progressContainer.style.display = 'none';
            fileInput.value = '';
            fileInfo.style.display = 'none';
            uploadArea.style.display = 'block';
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-play me-2"></i> Start Audit';
            downloadBtn.style.display = 'none';
            newAuditBtn.style.display = 'none';
            stopBtn.style.display = 'inline-block';
            stopBtn.disabled = false;
            stopBtn.innerHTML = '<i class="fas fa-stop me-2"></i> Stop & Download';
            progressBar.style.width = '0%';
        });
    </script>
</body>
</html>
